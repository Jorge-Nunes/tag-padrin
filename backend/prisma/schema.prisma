generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  OPERATOR
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(OPERATOR)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Tag {
  id                String       @id @default(uuid())
  brgpsId           String       @unique @map("brgps_id")
  name              String
  description       String?
  status            String       @default("ACTIVE")
  isActive          Boolean      @default(true)
  traccarUrl        String?      @map("traccar_url")
  lastLatitude      Float?       @map("last_latitude")
  lastLongitude     Float?       @map("last_longitude")
  lastSpeed         Float?       @map("last_speed")
  lastDirection     Int?         @map("last_direction")
  lastPositionAt    DateTime?    @map("last_position_at")
  lastSyncAt        DateTime?    @map("last_sync_at")
  lastTraccarSendAt DateTime?    @map("last_traccar_send_at")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")
  positions         Position[]
  traccarLogs       TraccarLog[]
  syncLogs          SyncLog[]

  @@map("tags")
  @@index([lastSyncAt])
  @@index([status])
}

model Position {
  id              String   @id @default(uuid())
  tagId           String   @map("tag_id")
  tag             Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  latitude        Float
  longitude       Float
  speed           Float?
  course          Float?
  direction       Int? // Alternative name for course used in some services
  timestamp       DateTime
  rawData         Json?    @map("raw_data")
  syncedToTraccar Boolean  @default(false)
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("positions")
  @@index([tagId, timestamp])
  @@index([createdAt])
}

model SyncLog {
  id            String   @id @default(uuid())
  tagId         String?  @map("tag_id")
  tag           Tag?     @relation(fields: [tagId], references: [id], onDelete: SetNull)
  status        String // SUCCESS, ERROR
  message       String?
  brgpsResponse Json?    @map("brgps_response")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("sync_logs")
  @@index([tagId, createdAt])
  @@index([status, createdAt])
}

model TraccarLog {
  id         String   @id @default(uuid())
  tagId      String   @map("tag_id")
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  positionId String?  @map("position_id")
  status     String // SUCCESS, ERROR
  payload    Json?
  response   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("traccar_logs")
  @@index([tagId, createdAt])
}

model SystemSettings {
  id            String   @id @default("default")
  syncInterval  Int      @default(60) @map("sync_interval")
  brgpsBaseUrl  String?  @map("brgps_base_url")
  brgpsToken    String?  @map("brgps_token")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model SyncOperation {
  id          String   @id @default(uuid())
  totalTags   Int      @map("total_tags")
  successCount Int     @map("success_count")
  failedCount Int      @map("failed_count")
  durationMs  Int?     @map("duration_ms")
  status      String   @default("SUCCESS") // SUCCESS, PARTIAL, FAILED
  message     String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("sync_operations")
  @@index([createdAt])
  @@index([status, createdAt])
}
